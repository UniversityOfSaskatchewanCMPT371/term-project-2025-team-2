import{l as m,r as T,u as i,j as t,e as C,G as y,F as S,T as D,D as A,t as V,c as F,d as L}from"./index-oEttahcb.js";import{g as w}from"./DicomParserUtils-D2IuqGbL.js";import{F as O}from"./CheckCircleIcon-YTPMvjMW.js";const k=(f,u)=>{m.debug(`Filtering rows with search term: ${u}`),m.debug(`Rows length: ${f.length}`);const s=u.toLowerCase(),h=e=>{if(!e)return[];if(Array.isArray(e))return m.debug("Filtering nested array of sequence items"),e.map(n=>{if(!(n!=null&&n.tags))return null;const r=Object.values(n.tags).filter(g=>{const x=(g.tagId??"").toString().toLowerCase(),c=(g.tagName??"").toString().toLowerCase(),p=(g.value??"").toString().toLowerCase();return x.includes(s)||c.includes(s)||p.includes(s)||l(g.value)});return r.length>0?{tags:Object.fromEntries(r.map(g=>[g.tagId,g]))}:null}).filter(n=>n!==null);if(typeof e=="object"&&e.tags){m.debug("Filtering single nested object with tags");const o=Object.values(e.tags).filter(n=>{const r=(n.tagId??"").toString().toLowerCase(),g=(n.tagName??"").toString().toLowerCase(),x=(n.value??"").toString().toLowerCase();return r.includes(s)||g.includes(s)||x.includes(s)||l(n.value)});if(o.length>0)return{tags:Object.fromEntries(o.map(n=>[n.tagId,n]))}}return null},l=e=>e?Array.isArray(e)?e.some(o=>o!=null&&o.tags?Object.values(o.tags).some(n=>{const r=(n.tagId??"").toString().toLowerCase(),g=(n.tagName??"").toString().toLowerCase(),x=(n.value??"").toString().toLowerCase();return r.includes(s)||g.includes(s)||x.includes(s)||l(n.value)}):!1):typeof e=="object"&&e.tags?Object.values(e.tags).some(o=>{const n=(o.tagId??"").toString().toLowerCase(),r=(o.tagName??"").toString().toLowerCase(),g=(o.value??"").toString().toLowerCase();return n.includes(s)||r.includes(s)||g.includes(s)||l(o.value)}):!1:!1;return T.useMemo(()=>f.map(e=>{const o=(e.tagId??"").toLowerCase(),n=(e.tagName??"").toLowerCase(),r=(e.value??"").toString().toLowerCase(),g=o.includes(s)||n.includes(s)||r.includes(s),x=l(e.value),c=x?h(e.value):null;return g?e:x&&c?{...e,value:c}:null}).filter(Boolean),[f,s])},M=(f,u,s)=>{m.debug("Creating rows for the DICOM table");const h=Object.entries(f.tags).map(([l,e])=>{var o,n;return{tagId:l,tagName:e.tagName,value:((o=s.find(r=>r.fileName===u&&r.tagId===l))==null?void 0:o.newValue)||e.value,hidden:e.hidden||!1,updated:!!((n=s.find(r=>r.fileName===u&&r.tagId===l))!=null&&n.newValue),delete:!!s.find(r=>r.fileName===u&&r.tagId===l&&r.delete)}});return s.forEach(l=>{l.add&&l.fileName===u&&h.push({tagId:l.tagId,tagName:w(l.tagId)||"Unknown",value:l.newValue,hidden:!1,updated:!1,delete:!1})}),m.debug(`Created ${h.length} rows for the DICOM table`),h},$=()=>{const f=i(u=>u.hideTagNumber);return m.debug("Rendering TableHeader component"),t.jsx("thead",{children:t.jsxs("tr",{className:"text-wrap bg-primary",children:[f?null:t.jsx("th",{className:"w-1/7 border px-4 py-2 text-primary-content",children:"Tag"}),t.jsx("th",{className:"w-1/4 border px-4 py-2 text-primary-content",children:"Tag Name"}),t.jsx("th",{className:"w-7/12 border px-4 py-2 text-primary-content",children:"Value"})]})})},U=({searchTerm:f,onSearchChange:u})=>(m.debug("Rendering Search component"),t.jsx("div",{className:"mb-4 flex items-center",children:t.jsxs("div",{className:"relative mr-4",children:[t.jsx("input",{type:"text","data-testid":"dicom-search-input",className:"rounded border px-4 py-2",placeholder:"Search tags...",value:f,onChange:s=>u(s.target.value)}),f&&t.jsx("button",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700",onClick:()=>u(""),children:"âœ•"})]})})),B=({searchTerm:f,onSearchChange:u,onSave:s})=>{const h=i(c=>c.dicomData),l=i(c=>c.setTags),e=i(c=>c.addTag),o=i(c=>c.setShowAddTag),n=i(c=>c.setSidePanelVisible),r=i(c=>c.tagsToAnon),g=new D;C(s!==null,"onSave should not be empty");const x=async()=>{m.info("Auto Anonymizing tags");const c=[],p=[];for(const N of h){const d=S(N,r);for(const a of d)p.some(b=>b.tagId===a.tagId)||p.push(a)}for(const N of p){const d=await g.getTag(N.tagId.slice(1)),a=d?d.name:"Unknown Tag";c.push({tagId:N.tagId,tagName:a,newValue:N.newValue})}m.debug(`Anonymizing tags: ${c}`),l(c),n(!0)};return m.debug("Rendering TableControls component"),t.jsxs("div",{className:"flex-col-2 flex",children:[t.jsx(U,{searchTerm:f,onSearchChange:u}),t.jsxs("div",{className:"flex-col-2 ml-4 flex",children:[t.jsx("div",{children:t.jsx(y,{label:"Download File",disabled:!1,onClick:s})}),t.jsx("div",{className:"ml-4",children:t.jsx(y,{onClick:x,label:"Auto Anon",disabled:!1})}),t.jsx("div",{className:"ml-4",children:t.jsx(y,{"data-testid":"DicomAddTag",onClick:()=>o(!e),label:e?"Close Add Tag":"Add Tag",disabled:!1})})]})]})},E=()=>t.jsx("tr",{children:t.jsx("td",{colSpan:3,className:"border px-4 py-2 text-center",children:"No matching tags found"})}),H=()=>{const[f,u]=T.useState(""),[s,h]=T.useState(""),[l,e]=T.useState(""),o=i(a=>a.setNewTagValues),n=i(a=>a.setShowAlert),r=i(a=>a.setAlertMsg),g=i(a=>a.setShowAddTag),x=i(a=>a.files),c=i(a=>a.currentFileIndex),p=i(a=>a.setAlertType),N=(a,b,j)=>{if(m.debug(`Adding new tag with: ${a}, ${b}`),a.length!==8||isNaN(parseInt(a))){m.debug(`New tag ID is not 8 numbers: ${a}`),p("alert-error"),r("Tag ID has to be 8 numbers"),n(!0);return}if(l.length<1){m.debug("New tag value is empty"),p("alert-error"),r("Tag Value can't be empty"),n(!0);return}if(s.length<1){m.debug("New tag name is empty"),p("alert-error"),r("Tag Name can't be empty"),n(!0);return}o({fileName:x[c].name,tagId:"X"+a,newValue:b,delete:j,add:!0}),u(""),h(""),e(""),g(!1),r("Tag: "+a+" added successfully"),p("alert-success"),n(!0)},d=a=>{const b=w("X"+a);return b||"Unknown"};return m.debug("Rendering NewTagRow component"),t.jsxs("tr",{children:[t.jsx("td",{className:"border px-4 py-2 text-center",children:t.jsxs("div",{className:"flex-col-2 flex",children:[t.jsx("div",{className:"mr-2",children:"X"}),t.jsx("input",{type:"text",className:"w-full",placeholder:"Tag ID",maxLength:8,onChange:a=>{u(a.target.value),h(d(a.target.value))}})]})}),t.jsx("td",{className:"border px-4 py-2 text-center",children:t.jsx("input",{type:"text",className:"w-full",placeholder:"Tag Name",disabled:!0,value:s})}),t.jsx("td",{className:"border px-4 py-2 text-center",children:t.jsxs("div",{className:"flex-col-2 flex",children:[t.jsx("input",{type:"text",className:"mr-4 w-full",placeholder:"Tag Value",onChange:a=>e(a.target.value)}),t.jsx(O,{"data-testid":"CheckCircleIcon",className:"h-8 w-8 cursor-pointer text-gray-500 hover:scale-110 hover:text-success",onClick:()=>N(f,l,!1)})]})})]})},R=({filteredRows:f,showHidden:u,onUpdateValue:s})=>{const h=i(e=>e.addTag),l=i(e=>e.newTagValues);return m.debug("Rendering DicomTableBody component"),t.jsxs("tbody",{children:[h?t.jsx(H,{}):null,f.length>0?f.map((e,o)=>e.hidden&&!u?null:t.jsx(A,{row:e,index:o,onUpdateValue:s,updated:e.updated},o+e.tagId+l.length)):t.jsx(E,{})]})},G=()=>{const[f,u]=T.useState(""),s=i(d=>d.files),h=i(d=>d.dicomData),l=i(d=>d.currentFileIndex),e=i(d=>d.newTagValues),o=i(d=>d.clearData),n=i(d=>d.setNewTagValues),r=i(d=>d.showHiddenTags),g=s[l].name;if(Object.keys(h[l].tags).length===0)return m.error("No DICOM data available"),t.jsx("div",{children:"No data available"});const x=M(h[l],g,e),c=k(x,f),p=(d,a,b)=>{n({fileName:s[l].name,tagId:d,newValue:a,delete:b,add:!1})},N=()=>{m.debug(`Updating file: ${s[l].name}`);const d=s[l].name,a=e.some(I=>I.fileName===d);m.debug(`File edited: ${a}`);const b=V(h[l].DicomDataSet,e),j=new Blob([b],{type:"application/dicom"}),v=F(d,j,a);L(v),o()};return m.debug("Rendering DICOM table"),t.jsxs("div",{className:"mt-8",children:[t.jsx("h2",{className:"text-2xl font-semibold",children:"DICOM Tags"}),t.jsx(B,{searchTerm:f,onSearchChange:u,onSave:N}),t.jsxs("table",{className:"mt-4 min-w-full table-auto border-collapse",style:{tableLayout:"fixed",width:"100%"},children:[t.jsx($,{}),t.jsx(R,{filteredRows:c,showHidden:r,onUpdateValue:p})]})]},g)};export{G as default};
